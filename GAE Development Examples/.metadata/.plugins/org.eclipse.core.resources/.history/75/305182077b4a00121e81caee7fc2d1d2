/**
 * 
 */
package com.GAE.examples.development;

import java.io.IOException;
import java.util.Iterator;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;


import com.GAE.examples.beans.GladiatorDataBean;
import com.GAE.examples.beans.LudusDataBean;
import com.GAE.examples.beans.UserDataBean;
import com.GAE.examples.utilities.*;


/**
 * @author dewie
 *
 */
@SuppressWarnings("serial")
public class BuyGladiator extends BaseServlet{
	private String loginRedirect = "/login";
	private String gladiatorMarketJsp = "/playerpages/gladiatorMarket.jsp";
	
	private int MAX_GLADIATORS_ALLOWED = 5;
	
	public void doGet(HttpServletRequest req, HttpServletResponse resp)
		      throws IOException, ServletException {
		if (!checkLogin(req)){			
			resp.sendRedirect(loginRedirect);
		} else {
			write_line(req, resp, "Page not available in this manner.");
		}		
	}
	
	public void doPost(HttpServletRequest req, HttpServletResponse resp)
			throws IOException {
		if (!checkLogin(req)){	//redirect if not logged in		
			resp.sendRedirect(loginRedirect);
		} else {
			//write_line(req, resp, (String)req.getParameter("gladiator"));
			String gladKey = req.getParameter("gladKey");
			log.info(gladKey);
			LudusDataBean recruits = (LudusDataBean)req.getSession().getAttribute("Recruits");
			if (gladKey == null || recruits == null){//if data didn't get passed correctly, 
				log.info("BuyGladiator.class: key value or bean not available");				
				write_line(req, resp, "Your request could not be processed at this time. Please try again later.");
			} else {
					Iterator<GladiatorDataBean> gldtrs = recruits.getGladiators().iterator();
					GladiatorDataBean selected = new GladiatorDataBean();
					Boolean test = false;
					while (gldtrs.hasNext() && !test){
						selected = gldtrs.next();
						if (selected.getKey().equals(gladKey)){
							test = true;
							log.info("BuyGladiator.java: Key found in list of available gladiators:" + selected.getKey());
						}
					}
				if (!test){
						log.info("BuyGladiator.java: key value or bean not available");
						write_line(req, resp, "Your request could not be processed at this time. Please try again later.");
				} else {
						UserDataBean usr = (UserDataBean)req.getSession().getAttribute("UserData");
						if (usr == null){
							log.info("BuyGladiator.class No user bean available. Buy failed");
						} else {
								if (usr.ludus.gladiators.size() >= MAX_GLADIATORS_ALLOWED){
									log.info("BuyGladiator.class User attempted to hold more than maximum number of gladiators");
									write_line(req, resp, "You have the maximum number of gladiators already.");
								} else {
									selected.setOwner((String)req.getSession().getAttribute("username"), selected.getKey());//with the added key string it is saved to the datastore
									usr.ludus.addNewGladiator(selected);
									req.getSession().setAttribute("UserData", usr);
									resp.sendRedirect(loginRedirect);
								}
						}
						
					}				
				}
			}			
		}

}
